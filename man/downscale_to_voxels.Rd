% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/downscale_to_voxels.R
\name{downscale_to_voxels}
\alias{downscale_to_voxels}
\title{Downscale a 2D fuel biomass raster into 3D lidar-derived voxels}
\usage{
downscale_to_voxels(
  las,
  fuel_rast,
  voxel_res = 1,
  can_min_z = 1,
  can_max_z = 50,
  occlusion = c("none", "beer"),
  beer_k = 0.5,
  max_adj = 5
)
}
\arguments{
\item{las}{A \code{LAS} object containing normalized lidar point cloud data.}

\item{fuel_rast}{A single-layer \code{SpatRaster} containing 2D fuel biomass values.}

\item{voxel_res}{Numeric. Vertical and horizontal resolution of voxels
(in map units).}

\item{can_min_z}{Numeric. Minimum canopy height (inclusive) to consider when
allocating biomass.}

\item{can_max_z}{Numeric. Maximum canopy height (inclusive) to consider when
allocating biomass.}

\item{occlusion}{Character. Occlusion correction method to apply. One of
\code{"none"} (default) or \code{"beer"}.}

\item{beer_k}{Numeric. Beer–Lambert attenuation coefficient controlling the
strength of the occlusion correction when \code{occlusion = "beer"}.}

\item{max_adj}{Numeric. Maximum allowed adjustment factor applied to any voxel
during occlusion correction.}
}
\value{
A \code{data.table} where each row represents a voxel and includes:
\itemize{
\item \code{X}, \code{Y}, \code{Z}: voxel center coordinates
\item \code{n}: number of lidar points in the voxel
\item \code{cell}: index of the source biomass raster cell
\item \code{bio}: original biomass value of the raster cell
\item \code{bio_vox}: final biomass allocated to the voxel
}

Biomass values are guaranteed (within numerical tolerance) to sum back to the
original raster cell values.
}
\description{
This function redistributes a 2D fuel biomass raster into a vertical stack of
3D voxels using lidar point density as a proxy for vertical fuel distribution.
Biomass within each raster cell is apportioned among vertical voxels in
proportion to the number of lidar returns in each voxel.
}
\details{
Optionally, a Beer–Lambert-style occlusion correction can be applied to increase
biomass allocation to lower canopy voxels based on the fraction of points above
each voxel.

Biomass is first allocated to voxels in proportion to lidar point density.
If occlusion correction is enabled, voxel biomass is adjusted using an
exponential Beer–Lambert-style function based on the fraction of points above
each voxel. A final reproportioning step ensures mass conservation.
}
\examples{
\dontrun{
library(lidR)
library(terra)

# get example data file paths
las_file <- system.file("extdata", "lidar_sample.laz", package = "voxelFuel")
fuel_file <- system.file("extdata", "fb_sample.tif", package = "voxelFuel")

# read in the example data
las <- readLAS(las_file)
fuel_rast <- rast(fuel_file)

# build voxel mask and align raster
voxel_mask <- build_voxel_mask(las)
fuel_rast <- align_and_mask_fuel_raster(fuel_rast, voxel_mask)

# downscale to voxels
fuel_vox <- downscale_to_voxels(las, fuel_rast, voxel_res = 1, can_min_z = 1, can_max_z = 50)

# rasterize voxel stack (optional)
vs <- rasterize_voxel_stack(fuel_vox, fuel_rast, out_dir = tempdir(), base_name = "example_voxel")
}

}
